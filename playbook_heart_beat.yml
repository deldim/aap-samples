---
- name: Long-running job test (write heartbeat on target)
  hosts: all
  gather_facts: false
  become: true

  vars:
    heartbeat_file: /tmp/aap_heartbeat.log
    interval_seconds: 5     # toutes les 5 secondes
    iterations: 120         # ~10 minutes

  tasks:
    - name: Write heartbeat every X seconds on the target
      ansible.builtin.shell: |
        set -euo pipefail
        for i in $(seq 1 {{ iterations }}); do
          ts="$(date -Is)"
          echo "${ts} host={{ inventory_hostname }} heartbeat=${i}/{{ iterations }}" >> "{{ heartbeat_file }}"
          if [ "$i" -lt "{{ iterations }}" ]; then
            sleep {{ interval_seconds }}
          fi
        done
      args:
        executable: /bin/bash

    - name: Show last 5 lines
      ansible.builtin.command: "tail -n 5 {{ heartbeat_file }}"
      register: tail_out
      changed_when: false

    - name: Debug tail output
      ansible.builtin.debug:
        var: tail_out.stdout_lines

