---
- name: Long-running job test (write heartbeat on target)
  hosts: all
  gather_facts: false
  become: true

  vars:
    heartbeat_file: /tmp/aap_heartbeat.log
    interval_seconds: 5        # Ã©crit toutes les 5s
    iterations: 120            # 120 * 5s = ~10 minutes

  tasks:
    - name: Ensure heartbeat file exists
      ansible.builtin.file:
        path: "{{ heartbeat_file }}"
        state: touch
        mode: "0644"

    - name: Heartbeat loop (write then sleep)
      block:
        - name: Append heartbeat line
          ansible.builtin.shell: |
            set -euo pipefail
            ts="$(date -Is)"
            echo "${ts} host={{ inventory_hostname }} heartbeat={{ i }}/{{ iterations }}" >> "{{ heartbeat_file }}"
          args:
            executable: /bin/bash

        - name: Sleep between heartbeats (except after last one)
          ansible.builtin.pause:
            seconds: "{{ interval_seconds }}"
          when: i < iterations
      loop: "{{ range(1, iterations + 1) | list }}"
      loop_control:
        loop_var: i

    - name: Show last 5 lines for quick verification
      ansible.builtin.command: "tail -n 5 {{ heartbeat_file }}"
      register: tail_out
      changed_when: false

    - name: Debug tail output
      ansible.builtin.debug:
        var: tail_out.stdout_lines

